<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sierra Leone Legal Assistant</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .flag {
        font-size: 3em;
        margin-bottom: 10px;
      }

      .chat-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .status-bar {
        background: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9em;
        color: #666;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #ccc;
        animation: pulse 2s infinite;
      }

      .status-dot.online {
        background: #4caf50;
      }

      .streaming-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85em;
        color: #666;
      }

      .toggle-switch {
        position: relative;
        width: 40px;
        height: 20px;
        background: #ccc;
        border-radius: 20px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .toggle-switch.active {
        background: #667eea;
      }

      .toggle-switch::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: white;
        top: 2px;
        left: 2px;
        transition: left 0.3s;
      }

      .toggle-switch.active::after {
        left: 22px;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .messages {
        height: 500px;
        overflow-y: auto;
        padding: 20px;
        background: #fafafa;
      }

      .message {
        margin-bottom: 20px;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.user {
        display: flex;
        justify-content: flex-end;
      }

      .message-content {
        max-width: 70%;
        padding: 15px 20px;
        border-radius: 18px;
        line-height: 1.5;
      }

      .message.user .message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
      }

      .message.assistant .message-content {
        background: white;
        color: #333;
        border: 1px solid #e0e0e0;
        border-bottom-left-radius: 4px;
      }

      .streaming-cursor {
        display: inline-block;
        width: 2px;
        height: 1em;
        background: #667eea;
        margin-left: 2px;
        animation: blink 1s infinite;
      }

      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0;
        }
      }

      .sources {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e0e0e0;
      }

      .sources-title {
        font-size: 0.85em;
        font-weight: 600;
        color: #666;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .source-item {
        background: #f8f9fa;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 8px;
        font-size: 0.85em;
        border-left: 3px solid #667eea;
      }

      .source-name {
        font-weight: 600;
        color: #667eea;
        margin-bottom: 4px;
      }

      .source-preview {
        color: #666;
        font-size: 0.9em;
        line-height: 1.4;
      }

      .loading {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px 20px;
        background: white;
        border-radius: 18px;
        border: 1px solid #e0e0e0;
        max-width: 120px;
      }

      .loading-dots {
        display: flex;
        gap: 4px;
      }

      .loading-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #667eea;
        animation: bounce 1.4s infinite ease-in-out both;
      }

      .loading-dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .loading-dot:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      .input-area {
        padding: 20px;
        background: white;
        border-top: 1px solid #e0e0e0;
      }

      .input-wrapper {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .input-field {
        flex: 1;
        padding: 15px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 1em;
        outline: none;
        transition: border-color 0.3s;
      }

      .input-field:focus {
        border-color: #667eea;
      }

      .send-button {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 1.2em;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .send-button:hover:not(:disabled) {
        transform: scale(1.1);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .examples {
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .example-chip {
        padding: 8px 15px;
        background: #f0f0f0;
        border-radius: 20px;
        font-size: 0.85em;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
      }

      .example-chip:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
        transform: translateY(-2px);
      }

      .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 15px;
        border-left: 4px solid #c62828;
        animation: slideIn 0.3s ease-out;
      }

      .welcome-message {
        text-align: center;
        padding: 40px 20px;
        color: #666;
      }

      .welcome-message h2 {
        color: #333;
        margin-bottom: 10px;
      }

      @media (max-width: 600px) {
        .header h1 {
          font-size: 1.8em;
        }

        .messages {
          height: 400px;
        }

        .message-content {
          max-width: 85%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="flag">ðŸ‡¸ðŸ‡±</div>
        <h1>Sierra Leone Legal Assistant</h1>
        <p>Ask questions about laws and policies in simple language</p>
      </div>

      <div class="chat-container">
        <div class="status-bar">
          <div class="streaming-toggle">
            <span>Streaming:</span>
            <div
              class="toggle-switch active"
              id="streamingToggle"
              onclick="toggleStreaming()"
            ></div>
            <span id="streamingStatus">ON</span>
          </div>
          <button
            onclick="clearChat()"
            style="
              background: none;
              border: none;
              cursor: pointer;
              color: #666;
              font-size: 0.9em;
            "
          >
            Clear Chat
          </button>
        </div>

        <div class="messages" id="messages">
          <div class="welcome-message">
            <h2>ðŸ‘‹ Welcome!</h2>
            <p>
              I'm here to help you understand Sierra Leone's laws and policies.
            </p>
            <p style="margin-top: 10px; font-size: 0.9em">
              Try asking a question or click one of the examples below.
            </p>
          </div>
        </div>

        <div class="input-area">
          <div class="examples" id="examples">
            <div class="example-chip" onclick="askExample(this)">
              What are my rights if I'm arrested?
            </div>
            <div class="example-chip" onclick="askExample(this)">
              How do I register a business?
            </div>
            <div class="example-chip" onclick="askExample(this)">
              What are voting requirements?
            </div>
            <div class="example-chip" onclick="askExample(this)">
              Freedom of speech protections
            </div>
          </div>
          <div class="input-wrapper">
            <input
              type="text"
              class="input-field"
              id="questionInput"
              placeholder="Ask a legal question..."
              onkeypress="handleKeyPress(event)"
            />
            <button
              class="send-button"
              id="sendButton"
              onclick="sendQuestion()"
            >
              âž¤
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "https://a2224b2f2621.ngrok-free.app";
      let isLoading = false;
      let streamingEnabled = true;

      function toggleStreaming() {
        streamingEnabled = !streamingEnabled;
        const toggle = document.getElementById("streamingToggle");
        const status = document.getElementById("streamingStatus");

        if (streamingEnabled) {
          toggle.classList.add("active");
          status.textContent = "ON";
        } else {
          toggle.classList.remove("active");
          status.textContent = "OFF";
        }
      }

      function handleKeyPress(event) {
        if (event.key === "Enter" && !isLoading) {
          sendQuestion();
        }
      }

      function askExample(element) {
        const question = element.textContent;
        document.getElementById("questionInput").value = question;
        sendQuestion();
      }

      function clearChat() {
        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = `
          <div class="welcome-message">
            <h2>ðŸ‘‹ Welcome!</h2>
            <p>I'm here to help you understand Sierra Leone's laws and policies.</p>
            <p style="margin-top: 10px; font-size: 0.9em;">Try asking a question or click one of the examples below.</p>
          </div>
        `;
      }

      async function sendQuestion() {
        if (isLoading) return;

        const input = document.getElementById("questionInput");
        const question = input.value.trim();

        if (!question) {
          showError("Please enter a question.");
          return;
        }

        input.value = "";
        addMessage(question, "user");

        isLoading = true;
        document.getElementById("sendButton").disabled = true;

        if (streamingEnabled) {
          await sendStreamingQuestion(question);
        } else {
          await sendNormalQuestion(question);
        }

        isLoading = false;
        document.getElementById("sendButton").disabled = false;
      }

      async function sendStreamingQuestion(question) {
        const messagesDiv = document.getElementById("messages");

        const messageDiv = document.createElement("div");
        messageDiv.className = "message assistant";
        messageDiv.innerHTML = `
          <div class="message-content">
            <span class="answer-text"></span><span class="streaming-cursor"></span>
          </div>
        `;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        const answerText = messageDiv.querySelector(".answer-text");
        const cursor = messageDiv.querySelector(".streaming-cursor");

        try {
          const response = await fetch(`${API_URL}/ask-stream`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ question }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split("\n");

            for (const line of lines) {
              if (line.startsWith("data: ")) {
                const data = JSON.parse(line.slice(6));

                if (data.type === "answer_chunk") {
                  answerText.textContent += data.content;
                  messagesDiv.scrollTop = messagesDiv.scrollHeight;
                } else if (data.type === "complete") {
                  cursor.remove();
                  if (data.sources && data.sources.length > 0) {
                    addSourcesToMessage(
                      messageDiv.querySelector(".message-content"),
                      data.sources
                    );
                  }
                } else if (data.type === "error") {
                  cursor.remove();
                  showError(data.error);
                }
              }
            }
          }
        } catch (error) {
          cursor.remove();
          console.error("Error:", error);
          showError(
            "Failed to get answer. Make sure the API server is running."
          );
        }
      }

      async function sendNormalQuestion(question) {
        showLoading();

        try {
          const response = await fetch(`${API_URL}/ask`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ question }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          removeLoading();
          addMessage(data.answer, "assistant", data.sources);
        } catch (error) {
          removeLoading();
          console.error("Error:", error);
          showError(
            "Failed to get answer. Make sure the API server is running."
          );
        }
      }

      function addSourcesToMessage(messageContent, sources) {
        const sourcesHtml = `
          <div class="sources">
            <div class="sources-title">ðŸ“š Sources (${sources.length})</div>
            ${sources
              .map(
                (source) => `
              <div class="source-item">
                <div class="source-name">
                  ${source.source}${source.page ? ` - Page ${source.page}` : ""}
                </div>
                <div class="source-preview">${source.content_preview.substring(
                  0,
                  150
                )}...</div>
              </div>
            `
              )
              .join("")}
          </div>
        `;
        messageContent.insertAdjacentHTML("beforeend", sourcesHtml);
      }

      function addMessage(content, type, sources = null) {
        const messagesDiv = document.getElementById("messages");
        const welcome = messagesDiv.querySelector(".welcome-message");
        if (welcome) welcome.remove();

        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;

        let sourcesHtml = "";
        if (sources && sources.length > 0) {
          sourcesHtml = `
            <div class="sources">
              <div class="sources-title">ðŸ“š Sources (${sources.length})</div>
              ${sources
                .map(
                  (source) => `
                <div class="source-item">
                  <div class="source-name">
                    ${source.source}${
                    source.page ? ` - Page ${source.page}` : ""
                  }
                  </div>
                  <div class="source-preview">${source.content_preview.substring(
                    0,
                    150
                  )}...</div>
                </div>
              `
                )
                .join("")}
            </div>
          `;
        }

        messageDiv.innerHTML = `
          <div class="message-content">
            ${content}
            ${sourcesHtml}
          </div>
        `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function showLoading() {
        const messagesDiv = document.getElementById("messages");
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "message assistant";
        loadingDiv.id = "loadingMessage";
        loadingDiv.innerHTML = `
          <div class="loading">
            <div class="loading-dots">
              <div class="loading-dot"></div>
              <div class="loading-dot"></div>
              <div class="loading-dot"></div>
            </div>
          </div>
        `;
        messagesDiv.appendChild(loadingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function removeLoading() {
        const loadingMsg = document.getElementById("loadingMessage");
        if (loadingMsg) loadingMsg.remove();
      }

      function showError(message) {
        const messagesDiv = document.getElementById("messages");
        const errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.textContent = "âš ï¸ " + message;
        messagesDiv.appendChild(errorDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        setTimeout(() => errorDiv.remove(), 5000);
      }
    </script>
  </body>
</html>
